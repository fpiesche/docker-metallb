FROM golang:alpine AS builder
ARG GIT_TAG=HEAD
ENV GIT_TAG=${GIT_TAG}

RUN apk add git
ADD ./ /docker-metallb
WORKDIR /docker-metallb/metallb/speaker

RUN echo "Building metallb-speaker ${GIT_TAG}"; \
  git checkout ${GIT_TAG} && \
  go build .

FROM alpine:3.14.2
COPY --from=builder /docker-metallb/metallb/speaker/speaker /usr/bin/metallb-speaker
CMD [ "/usr/bin/metallb-speaker" ]
